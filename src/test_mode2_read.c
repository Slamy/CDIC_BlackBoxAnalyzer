#include "hwreg.h"
#include "framework.h"

/* Reads the map theme of Zelda - Wand of Gamelon as data */
void test_mode2_read()
{
    int i, j;

    printf("# test_mode2_read()\n");

    resetcdic();
    print_state();
    cdic_irq_occured = 0;

    for (i = 0; i < 16; i++)
    {
        CDIC_RAM_DBUF0[i] = 0x5555;
        CDIC_RAM_DBUF1[i] = 0x5555;
    }

    /* Does this even have an effect? */
    printf("RAM Readback %x %x \n", CDIC_RAM_DBUF0[0], CDIC_RAM_DBUF1[0]);

    /* Zelda - Wand of Gamelon - Map Theme*/
    CDIC_FILE = 0x0100;     /* MODE2 File filter */
    CDIC_CHAN = 0xffff;     /* We want all the channels! */
    CDIC_ACHAN = 0x0000;    /* Reset to 0, to fetch even audio sectors into normal data buffers */
    CDIC_TIME = 0x24362100; /* MSF 24:36:21 */
    CDIC_CMD = CMD_MODE2;   /* Command = Read MODE2 */
    CDIC_DBUF = 0xc000;     /* Execute command */

    bufpos = 0;
    timecnt = 0;
    while (bufpos < 6)
    {
        if (cdic_irq_occured)
        {
            cdic_irq_occured = 0;

            if (timecnt < 100)
            {
                printf("Spurious IRQ!\n");
            }

            for (i = 0; i < 16; i++)
            {
                reg_buffer[bufpos][i] = CDIC_RAM_DBUF0[i];
                reg_buffer[bufpos][i + 16] = CDIC_RAM_DBUF1[i];
            }
            reg_buffer[bufpos][32] = int_dbuf;
            reg_buffer[bufpos][33] = timecnt;
            reg_buffer[bufpos][34] = int_audctl;

            timecnt = 0;

            bufpos++;
        }
        timecnt++;
        if (timecnt > 300000)
        {
            printf("Timeout!\n");
            break;
        }
    }

    printf("Got %d entries\n", bufpos);

    for (i = 0; i < bufpos; i++)
    {
        printf("%3d ", i);
        for (j = 0; j < 35; j++)
        {
            printf(" %04x", reg_buffer[i][j]);
        }

        printf("\n");
    }

    /* Output on 210/05 with Zelda - Wand of Gamelon in tray
    # test_mode2_read()
    State INT: 0000 0000 0000 d7fe  Now: 7fff 7fff 0800 d7fe
    RAM Readback 5555 5555
    Got 6 entries
    0  ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 5555 c800 0083 d7fe
    1  2436 2102 0100 6401 0100 6401 2c3b 1c1c 2c3b 1c1c 1c1c 1c1c 1c1c 1c1c 00d4 dcf4 2436 2202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 f7f6 d7fe
    2  2436 2302 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2436 2202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 02d7 d7fe
    3  2436 2302 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2436 2402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 02e4 d7fe
    4  2436 2502 0100 6401 0100 6401 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 2103 c0d5 2436 2402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 02d7 d7fe
    5  2436 2502 0100 6401 0100 6401 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 2103 c0d5 2436 2602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 02d7 d7fe
    */
}

/* MODE2 reading of data, pausing and resuming with DBUF = 0x4000
 */
void test_mode2_read_stop_read()
{
    int i, j, o;

    printf("# test_mode2_read_stop_read()\n");

    resetcdic();
    print_state();
    cdic_irq_occured = 0;

    for (i = 0; i < 16; i++)
    {
        CDIC_RAM_DBUF0[i] = 0x5555;
        CDIC_RAM_DBUF1[i] = 0x5555;
    }

    /* Does this even have an effect? */
    printf("RAM Readback %x %x \n", CDIC_RAM_DBUF0[0], CDIC_RAM_DBUF1[0]);

    for (o = 0; o < 3; o++)
    {
        print_state();

        if (o == 0)
        {
            /* Zelda - Wand of Gamelon - Map Theme*/
            CDIC_FILE = 0x0100;     /* MODE2 File filter */
            CDIC_CHAN = 0xffff;     /* We want all the channels! */
            CDIC_ACHAN = 0x0000;    /* Reset to 0, to fetch even audio sectors into normal data buffers */
            CDIC_TIME = 0x24362100; /* MSF 24:36:21 */
            CDIC_CMD = CMD_MODE2;   /* Command = Read MODE2 */
            CDIC_DBUF = 0xC000;     /* Execute command */
        }
        else
        {
            CDIC_DBUF = 0x4000; /* Execute command */
        }

        bufpos = 0;
        timecnt = 0;
        while (bufpos < 20)
        {
            if (cdic_irq_occured)
            {
                cdic_irq_occured = 0;

                if (timecnt < 100)
                {
                    /* printf("Spurious IRQ!\n"); */
                }

                for (i = 0; i < 16; i++)
                {
                    reg_buffer[bufpos][i] = CDIC_RAM_DBUF0[i];
                    reg_buffer[bufpos][i + 16] = CDIC_RAM_DBUF1[i];
                }
                reg_buffer[bufpos][32] = int_dbuf;
                reg_buffer[bufpos][33] = timecnt;
                reg_buffer[bufpos][34] = int_audctl;

                timecnt = 0;

                bufpos++;
            }

            if (bufpos == 10)
            {
                CDIC_DBUF = 0;
            }

            timecnt++;
            if (timecnt > 300000)
            {
                printf("Timeout!\n");
                break;
            }
        }

        printf("Got %d entries\n", bufpos);

        for (i = 0; i < bufpos; i++)
        {
            printf("%3d ", i);
            for (j = 0; j < 35; j++)
            {
                printf(" %04x", reg_buffer[i][j]);
            }

            printf("\n");
        }
    }

    /* Output on 210/05 with Zelda - Wand of Gamelon in tray
    # test_mode2_read_stop_read()
    State INT: 0000 0000 0000 d7fe  Now: 7fff 7fff 0801 d7fe
    RAM Readback 5555 5555
    State INT: 0000 0000 0000 0000  Now: 7fff ffff 0800 d7fe
    Timeout!
    Got 10 entries
    0  ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 ffc0 c800 00b6 d7fe
    1  2436 2102 0100 6401 0100 6401 2c3b 1c1c 2c3b 1c1c 1c1c 1c1c 1c1c 1c1c 00d4 dcf4 2436 2202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 ae2e d7fe
    2  2436 2302 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2436 2202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0249 d7fe
    3  2436 2302 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2436 2402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0246 d7fe
    4  2436 2502 0100 6401 0100 6401 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 2103 c0d5 2436 2402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0242 d7fe
    5  2436 2502 0100 6401 0100 6401 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 1c1c 2103 c0d5 2436 2602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0248 d7fe
    6  2436 2702 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2436 2602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0246 d7fe
    7  2436 2702 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2436 2802 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0244 d7fe
    8  2436 2902 0100 6401 0100 6401 1c1c 1c1c 1c1c 1c1c 1c1c 1c2c 1c1c 1c2c fe04 e52e 2436 2802 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0246 d7fe
    9  2436 2902 0100 6401 0100 6401 1c1c 1c1c 1c1c 1c1c 1c1c 1c2c 1c1c 1c2c fe04 e52e 2436 3002 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0247 d7fe
    State INT: 7fff ffff 4820 d7fe  Now: 7fff ffff 0821 d7fe
    Timeout!
    Got 10 entries
    0  2446 2502 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2446 2602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 00aa d7fe
    1  2446 2702 0100 6401 0100 6401 1434 2424 1434 2424 3535 3434 3535 3434 e01e 8a33 2446 2602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0166 d7fe
    2  2446 2702 0100 6401 0100 6401 1434 2424 1434 2424 3535 3434 3535 3434 e01e 8a33 2446 2802 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0167 d7fe
    3  2446 2902 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2446 2802 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 01c5 d7fe
    4  2446 2902 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2446 3002 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 024b d7fe
    5  2446 3102 0100 6401 0100 6401 2425 2625 2425 2625 2525 2525 2525 2525 2136 bf90 2446 3002 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0243 d7fe
    6  2446 3102 0100 6401 0100 6401 2425 2625 2425 2625 2525 2525 2525 2525 2136 bf90 2446 3202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0244 d7fe
    7  2446 3302 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2446 3202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 024b d7fe
    8  2446 3302 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2446 3402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0242 d7fe
    9  2446 3502 0100 6401 0100 6401 2535 2625 2535 2625 2534 3526 2534 3526 bd01 241c 2446 3402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0244 d7fe
    State INT: 7fff ffff 4821 d7fe  Now: 7fff ffff 0820 d7fe
    Timeout!
    Got 10 entries
    0  2456 3302 0100 6401 0100 6401 2434 1323 2434 1323 3433 2323 3433 2323 ed0f 0ac0 2456 3202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0012 d7fe
    1  2456 3302 0100 6401 0100 6401 2434 1323 2434 1323 3433 2323 3433 2323 ed0f 0ac0 2456 3402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 015e d7fe
    2  2456 3502 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2456 3402 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0170 d7fe
    3  2456 3502 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2456 3602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 016c d7fe
    4  2456 3702 0100 6401 0100 6401 3434 1424 3434 1424 2323 2424 2323 2424 0362 000e 2456 3602 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0244 d7fe
    5  2456 3702 0100 6401 0100 6401 3434 1424 3434 1424 2323 2424 2323 2424 0362 000e 2456 3802 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 024d d7fe
    6  2456 3902 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2456 3802 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 0241 d7fe
    7  2456 3902 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 2456 4002 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0243 d7fe
    8  2456 4102 0100 6401 0100 6401 2434 2534 2434 2534 2434 2434 2434 2434 f105 dddf 2456 4002 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4821 024e d7fe
    9  2456 4102 0100 6401 0100 6401 2434 2534 2434 2534 2434 2434 2434 2434 f105 dddf 2456 4202 0100 6000 0100 6000 0000 0000 0000 0000 0000 0000 0000 0000 0000 0000 4820 0240 d7fe
    */
}
